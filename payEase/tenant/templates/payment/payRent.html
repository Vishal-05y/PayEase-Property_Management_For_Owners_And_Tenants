{% extends "base/tenant_layout.html" %}

{% block title %}Pay Rent{% endblock %}

{% block navbar %}
<a href="{% url 'tenantDashboard' %}" class="hover-accent transition">Dashboard</a>

<a href="{% url 'logoutTenant' %}">
    <button class="px-2 py-1 rounded transition btn-red">
        Logout
    </button>
</a>
{% endblock %}

{% block content %}

<div class="max-w-3xl mx-auto p-6">

    <!-- Title -->
    <h1 class="text-3xl sm:text-4xl font-extrabold text-primary mb-8 text-center">
        Pay Rent
    </h1>

    <!-- BUILDING CARD -->
    <section class="mb-4 bg-card border-dark rounded-2xl p-6 shadow">
        <h2 class="text-lg font-semibold text-primary mb-2">Building Details</h2>
        <p class="text-primary">
            <span class="text-muted font-semibold">Name:</span> {{ tenant.flat.building.name }}
        </p>
        <p class="text-primary mt-1">
            <span class="text-muted font-semibold">Address:</span> {{ tenant.flat.building.address }}
        </p>
    </section>

    <!-- OWNER CARD -->
    <section class="mb-4 bg-card border-dark rounded-2xl p-6 shadow">
        <h2 class="text-lg font-semibold text-primary mb-2">Owner Details</h2>
        <p class="text-primary">
            <span class="text-muted font-semibold">Name:</span> {{ tenant.flat.building.owner.name }}
        </p>
        <p class="text-primary mt-1">
            <span class="text-muted font-semibold">Phone:</span> {{ tenant.flat.building.owner.phone }}
        </p>
    </section>

    <!-- TENANT CARD -->
    <section class="mb-4 bg-card border-dark rounded-2xl p-6 shadow">
        <h2 class="text-lg font-semibold text-primary mb-2">Your Details</h2>

        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-center">
            <div>
                <p class="text-muted text-sm">Name</p>
                <p class="text-primary font-medium">{{ tenant.name }}</p>
            </div>

            <div>
                <p class="text-muted text-sm">Flat</p>
                <p class="text-primary font-medium">{{ tenant.flat.flat_number }} ({{ tenant.flat.flat_type }})</p>
            </div>

            <div>
                <p class="text-muted text-sm">Month</p>
                <p class="text-primary font-medium">{{ current_month }}</p>
            </div>
        </div>

        <div class="mt-6">
            <p class="text-muted text-sm">Amount Due</p>
            <p class="text-3xl font-extrabold mt-1" style="color: #22c55e;">
                â‚¹{{ tenant.flat_price }}
            </p>
        </div>
    </section>

    <!-- PAYMENT ACTION -->
    <div class="mt-4">
        {% if already_paid %}
            <p class="text-center text-lg font-semibold" style="color:#16a34a;">
                Rent already paid for {{ current_month }}.
            </p>
        {% else %}
            <div class="max-w-md mx-auto mt-4">
                <button onclick="payNow()"
                    class="w-full py-3 rounded-xl font-semibold shadow transition"
                    style="background:#16a34a; color:var(--text-primary);"
                    onmouseover="this.style.background='#15803d'"
                    onmouseout="this.style.background='#16a34a'">
                    Proceed to Payment
                </button>
            </div>
        {% endif %}
    </div>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
function payNow() {
    fetch("{% url 'createOrder' %}", {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}"
        }
    })
    .then(res => res.json())
    .then(data => {

        var options = {
            "key": data.key_id,
            "amount": data.amount,
            "currency": "INR",
            "name": "Rent Payment",
            "description": "Monthly Rent",
            "order_id": data.order_id,

            "handler": function (response) {
                const params = new URLSearchParams({
                    payment_id: response.razorpay_payment_id,
                    order_id: response.razorpay_order_id,
                    signature: response.razorpay_signature
                }).toString();

                window.location.href = "/tenant/paymentSuccess/?" + params;
            }

        };

        var rzp = new Razorpay(options);
        rzp.open();
    });
}
</script>

{% endblock %}
