{% extends "building/buildingDetails.html" %}

{% block title %}Building Gallery{% endblock %}

{% block navbar %}
<a href="{% url 'ownerDashboard' %}" class="transition hover-accent">Dashboard</a>
<a href="{% url 'addBuilding' %}" class="transition hover-accent">Add Building</a>

<a href="{% url 'logoutOwner' %}">
    <button class="px-2 py-1 rounded-lg transition btn-red">
        Logout
    </button>
</a>
{% endblock %}


{% block back %}
<a href="{% url 'buildingDetails' building.id%}" class="text-accent transition">Back</a>
{% endblock %}


{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-2 gap-10">

    <!-- IMAGE GALLERY -->
    <div class="bg-card p-8 rounded-2xl border-dark shadow">

        <h2 class="text-2xl font-semibold text-primary mb-6">Images</h2>

        {% if building.images.all %}
        <div class="grid grid-cols-2 md:grid-cols-3 gap-6">

            {% for img in building.images.all %}
            <div class="relative group rounded-xl border-dark border overflow-hidden shadow-sm bg-card">

                <img src="{{ img.image.url }}"
                     class="w-full h-48 object-cover rounded-xl cursor-pointer"
                     onclick="openSlider({{ forloop.counter0 }})">

                <a href="{% url 'deleteBuildingImage' img.id %}"
                   class="absolute top-2 right-2 px-3 py-1 text-sm rounded-lg 
                          bg-red-600 text-white opacity-0 group-hover:opacity-100 transition">
                    Delete
                </a>

            </div>
            {% endfor %}

        </div>

        {% else %}
        <p class="text-muted">No images uploaded yet.</p>
        {% endif %}
    </div>



    <!-- UPLOAD SECTION -->
    <div class="bg-card p-8 rounded-2xl border-dark shadow">

        <h2 class="text-2xl font-semibold text-primary mb-4">Upload Images</h2>

        {% if request.session.upload_error %}
        <div class="p-3 rounded-lg mb-4"
             style="background:rgba(244,63,94,0.15); border:1px solid var(--btn-red); color:var(--btn-red);">
            {{ request.session.upload_error }}
        </div>

        <script>
            fetch("/owner/clear-upload-error/");
        </script>
        {% endif %}

        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}

            <input type="file" name="images" multiple accept="image/*"
                   class="w-full p-3 rounded-lg bg-card text-primary border-dark transition"
                   onchange="checkLimit(this, {{ building.images.count }})"
                   onfocus="this.classList.add('border-light')"
                   onblur="this.classList.remove('border-light')">

            <button class="mt-4 px-6 py-3 rounded-xl shadow font-semibold transition btn-blue">
                Upload
            </button>

        </form>
    </div>

</div>



<!-- SLIDER MODAL -->
<div id="sliderModal"
     class="fixed inset-0 bg-black bg-opacity-80 hidden z-50 flex items-center justify-center">

    <img id="sliderImage"
         src=""
         class="max-h-[90%] max-w-[90%] rounded-lg shadow-lg">

    <button onclick="closeSlider()" 
            class="absolute top-5 right-5 text-white text-3xl font-bold">✕</button>

    <button onclick="prevSlide()" 
            class="absolute left-5 text-white text-4xl font-bold">❮</button>

    <button onclick="nextSlide()" 
            class="absolute right-5 text-white text-4xl font-bold">❯</button>

</div>



<script>
function checkLimit(input, currentCount) {
    if (currentCount + input.files.length > 5) {
        alert("Max 5 images allowed!");
        input.value = "";
    }
}

let sliderIndex = 0;
let sliderImages = [
    {% for img in building.images.all %}
    "{{ img.image.url }}",
    {% endfor %}
];

function openSlider(i) {
    sliderIndex = i;
    document.getElementById("sliderModal").classList.remove("hidden");
    updateSlider();
}

function closeSlider() {
    document.getElementById("sliderModal").classList.add("hidden");
}

function updateSlider() {
    document.getElementById("sliderImage").src = sliderImages[sliderIndex];
}

function nextSlide() {
    sliderIndex = (sliderIndex + 1) % sliderImages.length;
    updateSlider();
}

function prevSlide() {
    sliderIndex = (sliderIndex - 1 + sliderImages.length) % sliderImages.length;
    updateSlider();
}
</script>

{% endblock %}
