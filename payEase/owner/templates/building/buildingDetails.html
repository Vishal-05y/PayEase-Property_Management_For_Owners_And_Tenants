{% extends "owner/ownerDashboard.html" %}

{% block title %}Building Details{% endblock %}


{% block back %}
<a href="{% url 'ownerDashboard' %}" class="text-accent transition">Back</a>
{% endblock %}


{% block building_details %}
<div class="flex-col items-start mb-5">
    
    <h1 class="text-3xl font-extrabold tracking-tight mb-2 text-primary">
        üè° {{ building.name }}
    </h1>

    <p class="text-lg leading-relaxed text-muted">
        <span class="font-semibold text-primary">Address:</span> {{ building.address }}
    </p>

    <p class="text-lg leading-relaxed text-muted">
        <span class="font-semibold text-primary">Cost:</span> ‚Çπ{{ building.cost }}
    </p>

</div>
{% endblock %}


{% block content %}

<!-- ACTION BUTTONS -->
<div class="flex flex-row space-x-1.5">

    <a href="{% url 'buildingGallery' building.id %}">
        <button class="px-4 py-2 rounded-xl shadow font-semibold transition btn-ash">
            Gallery
        </button>
    </a>

    <a href="{% url 'editBuilding' building.id %}">
        <button class="px-4 py-2 rounded-xl shadow font-semibold transition btn-amber">
            Edit
        </button>
    </a>

    <a href="{% url 'addFlat' building.id %}">
        <button class="px-4 py-2 rounded-xl shadow font-semibold transition btn-blue">
            Add Flat
        </button>
    </a>

    {% comment %} <a href="{% url 'ownerBuildingPayments' building.id %}">
        <button class="px-4 py-2 rounded-lg btn-blue">
            Building Payments
        </button>
    </a> {% endcomment %}

</div>



<!-- UNPAID RENT -->
<h2 class="text-2xl font-bold mt-5 mb-3 text-red-400">
    Unpaid Rent ‚Äî {{ current_month }}
</h2>

{% if unpaid_tenants %}
<div class="space-y-4 mb-5">

    {% for t in unpaid_tenants %}
    <div class="p-5 rounded-xl shadow bg-card border-dark">

        <h3 class="text-xl font-semibold text-red-400">
            {{ t.name }} ({{ t.phone }})
        </h3>

        <p class="mt-1 text-muted">
            <strong class="text-primary">Building:</strong> {{ t.flat.building.name }}
        </p>

        <p class="text-muted">
            <strong class="text-primary">Flat:</strong> {{ t.flat.flat_number }} ‚Ä¢ {{ t.flat.flat_type }}
        </p>

        <p class="text-muted">
            <strong class="text-primary">Rent:</strong> ‚Çπ{{ t.flat_price }}
        </p>

        <p class="font-semibold mt-2 text-red-400">Not Paid</p>

        <a href="{% url 'flatDetails' t.flat.building.id t.flat.id %}">
            <button class="mt-3 px-3 py-1 rounded-lg shadow transition btn-blue">
                View Flat
            </button>
        </a>

    </div>
    {% endfor %}

</div>

{% else %}
<p class="text-lg mb-5 text-muted">
    All tenants have paid rent for {{ current_month }}
</p>
{% endif %}



<!-- FLATS SECTION -->
<h2 class="text-3xl font-bold mb-6 mt-9 text-primary">Available Flats</h2>

{% if building.flats.all %}
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">

    {% for flat in building.flats.all %}
    <div class="p-6 rounded-2xl shadow-sm transition bg-card border-dark bg-card-hover">

        <h3 class="text-xl font-bold text-primary">
            Flat {{ flat.flat_number }}
        </h3>

        <p class="mt-1 text-muted">
            Type: <span class="font-semibold text-primary">{{ flat.flat_type }}</span>
        </p>

        <a href="{% url 'flatDetails' building.id flat.id %}">
            <button class="mt-5 px-5 py-2 rounded-lg transition shadow font-semibold btn-blue">
                View Flat
            </button>
        </a>

        <button
            onclick="openDeleteModal('{{ flat.id }}', '{{ flat.flat_number }}')"
            class="mt-5 px-5 py-2 rounded-lg transition shadow font-semibold btn-red">
            Delete Flat
        </button>

    </div>
    {% endfor %}

</div>

{% else %}
<p class="text-lg mt-4 text-muted">No flats added yet.</p>
{% endif %}



<!-- DELETE MODAL -->
<div id="deleteModal"
     class="fixed inset-0 bg-opacity-30 backdrop-blur-sm flex justify-center items-center hidden z-50">

    <div class="p-8 rounded-xl shadow-xl w-11/12 sm:w-96 bg-card border-dark">

        <h2 class="text-2xl font-bold mb-4 text-red-400">Delete Flat</h2>

        <p id="deleteMessage" class="mb-6 text-primary">
            Are you sure you want to delete this flat?
        </p>

        <div id="deleteError"
             class="hidden p-3 rounded-lg mb-4"
             style="background:rgba(244,63,94,0.15);
                    border:1px solid var(--btn-red);
                    color:var(--btn-red);">
        </div>

        <div class="flex justify-end gap-3">

            <button onclick="closeDeleteModal()"
                    class="px-4 py-2 rounded-lg transition btn-ash">
                Cancel
            </button>

            <button id="confirmDeleteBtn"
                    onclick="confirmDelete()"
                    class="px-4 py-2 rounded-lg transition btn-red">
                Delete
            </button>

        </div>

    </div>
</div>


<script>
let deleteFlatId = null;

function openDeleteModal(flatId, flatNumber) {
    deleteFlatId = flatId;
    document.getElementById("deleteModal").classList.remove("hidden");
    document.getElementById("deleteMessage").innerText =
        `Are you sure you want to delete Flat ${flatNumber}? This action cannot be undone.`;
    document.getElementById("deleteError").classList.add("hidden");
}

function closeDeleteModal() {
    document.getElementById("deleteModal").classList.add("hidden");
}

function confirmDelete() {
    fetch(`/owner/buildings/{{ building.id }}/flat/${deleteFlatId}/delete/`)
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                document.getElementById("deleteError").innerText = data.message;
                document.getElementById("deleteError").classList.remove("hidden");
                return;
            }
            location.reload();
        });
}
</script>

{% endblock %}